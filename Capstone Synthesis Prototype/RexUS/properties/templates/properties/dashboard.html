<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RexUS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">RexUS</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <span class="navbar-text text-white me-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-person-circle me-1"
                  viewBox="0 0 16 16"
                >
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                  <path
                    fill-rule="evenodd"
                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"
                  />
                </svg>
                {{ user.get_full_name }}
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{% url 'dashboard' %}"
                >Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'file_list' %}">My Files</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'upload' %}">Upload Data</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'logout' %}">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <h2 class="mb-4">Dashboard</h2>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-white bg-primary mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Files</h5>
              <h2 class="card-text">{{ total_files }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-white bg-success mb-3">
            <div class="card-body">
              <h5 class="card-title">Processed Files</h5>
              <h2 class="card-text">{{ processed_files }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-white bg-info mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Records</h5>
              <h2 class="card-text">{{ total_records|default:0 }}</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h5 class="card-title mb-0">Recent Files</h5>
                <a href="{% url 'file_list' %}" class="btn btn-primary btn-sm"
                  >View All Files</a
                >
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>File Name</th>
                      <th>Records</th>
                      <th>Status</th>
                      <th>Uploaded</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for file in recent_files %}
                    <tr>
                      <td>{{ file.name }}</td>
                      <td>{{ file.record_count|default:"0" }}</td>
                      <td>
                        {% if file.status == 'processed' %}
                        <span class="badge bg-success">Processed</span>
                        {% elif file.status == 'processing' %}
                        <span class="badge bg-warning">Processing</span>
                        {% elif file.status == 'uploaded' %}
                        <span class="badge bg-info">Uploaded</span>
                        {% elif file.status == 'error' %}
                        <span class="badge bg-danger">Error</span>
                        {% endif %}
                      </td>
                      <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
                      <td>
                        {% if file.status == 'processed' %}
                        <a
                          href="{% url 'file_detail' file.id %}"
                          class="btn btn-sm btn-primary"
                          >View</a
                        >
                        {% elif file.status == 'uploaded' %}
                        <a
                          href="{% url 'process_file' file.id %}"
                          class="btn btn-sm btn-warning"
                          >Process</a
                        >
                        {% elif file.status == 'error' %}
                        <a
                          href="{% url 'file_detail' file.id %}"
                          class="btn btn-sm btn-secondary"
                          >Details</a
                        >
                        {% endif %}
                        <button
                          class="btn btn-sm btn-danger"
                          data-file-id="{{ file.id }}"
                          data-file-name="{{ file.name }}"
                          onclick="deleteFile(this)"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-trash"
                            viewBox="0 0 16 16"
                          >
                            <path
                              d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"
                            />
                            <path
                              d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"
                            />
                          </svg>
                        </button>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="5" class="text-center">
                        No files uploaded yet.
                        <a href="{% url 'upload' %}">Upload your first file</a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function deleteFile(button) {
        const fileId = button.dataset.fileId;
        const fileName = button.dataset.fileName;

        console.log("Delete button clicked for file:", fileId, fileName);

        if (
          confirm(
            `Are you sure you want to delete "${fileName}"? This action cannot be undone.`
          )
        ) {
          console.log("User confirmed deletion");

          // Create a form to submit the delete request
          const form = document.createElement("form");
          form.method = "POST";
          form.action = `/dashboard/files/${fileId}/delete/`;

          console.log("Form action:", form.action);

          // Add CSRF token
          const csrfTokenValue = getCookie("csrftoken");
          console.log("CSRF token:", csrfTokenValue ? "Found" : "Not found");

          if (csrfTokenValue) {
            const csrfInput = document.createElement("input");
            csrfInput.type = "hidden";
            csrfInput.name = "csrfmiddlewaretoken";
            csrfInput.value = csrfTokenValue;
            form.appendChild(csrfInput);
          }

          document.body.appendChild(form);
          console.log("Submitting form...");
          form.submit();
        } else {
          console.log("User cancelled deletion");
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>
